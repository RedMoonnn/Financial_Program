# å‹åŠ›æµ‹è¯•æŒ‡å— (Stress Testing Guide)

## 1. ä»€ä¹ˆæ˜¯å‹åŠ›æµ‹è¯•ï¼Ÿ

å‹åŠ›æµ‹è¯•ï¼ˆStress Testingï¼‰æ˜¯ä¸€ç§æ€§èƒ½æµ‹è¯•ï¼Œé€šè¿‡æ¨¡æ‹Ÿé«˜äºæ­£å¸¸è´Ÿè½½çš„æµé‡ï¼ˆå¦‚å¤§é‡å¹¶å‘ç”¨æˆ·ã€é«˜é¢‘è¯·æ±‚ï¼‰ï¼Œå¯¹ç³»ç»Ÿæ–½åŠ æç«¯å‹åŠ›ï¼Œä»¥éªŒè¯ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå¯é æ€§ã€‚

### ä¸»è¦ç›®çš„ï¼š
- **è¯„ä¼°ç¨³å®šæ€§**ï¼šç³»ç»Ÿåœ¨é«˜è´Ÿè½½ä¸‹æ˜¯å¦ä¼šå´©æºƒã€å†…å­˜æ³„æ¼æˆ–æŒ‚èµ·ã€‚
- **å‘ç°ç“¶é¢ˆ**ï¼šè¯†åˆ« CPUã€å†…å­˜ã€æ•°æ®åº“è¿æ¥æ± æˆ–ç½‘ç»œå¸¦å®½çš„é™åˆ¶ã€‚
- **éªŒè¯æ¢å¤èƒ½åŠ›**ï¼šå½“è´Ÿè½½æ¢å¤æ­£å¸¸åï¼Œç³»ç»Ÿèƒ½å¦è‡ªåŠ¨æ¢å¤ã€‚
- **ç¡®å®šå®¹é‡**ï¼šäº†è§£ç³»ç»Ÿèƒ½æ”¯æ’‘çš„æœ€å¤§å¹¶å‘ç”¨æˆ·æ•° (TPS/QPS)ã€‚

---

## 2. æ¨èå·¥å…·

é’ˆå¯¹æœ¬é¡¹ç›®çš„æŠ€æœ¯æ ˆï¼ˆPython/FastAPI + Reactï¼‰ï¼Œæ¨èä½¿ç”¨ä»¥ä¸‹å·¥å…·ï¼š

### ğŸ¥‡ æ¨èï¼šLocust

**Locust** æ˜¯ä¸€ä¸ªæ˜“äºä½¿ç”¨çš„ã€åˆ†å¸ƒå¼çš„ã€åŸºäº Python çš„è´Ÿè½½æµ‹è¯•å·¥å…·ã€‚

*   **ä¼˜ç‚¹**ï¼š
    *   **Python ç¼–å†™è„šæœ¬**ï¼šæ— éœ€å­¦ä¹ æ–°è¯­æ³•ï¼Œå¯ä»¥ç›´æ¥å¤ç”¨é¡¹ç›®ä¸­çš„ API å®¢æˆ·ç«¯ä»£ç ã€‚
    *   **å¹¶å‘æ€§å¼º**ï¼šåŸºäºåç¨‹ï¼ˆGeventï¼‰ï¼Œå•æœºæ”¯æŒæ•°åƒå¹¶å‘ã€‚
    *   **å®æ—¶ Web UI**ï¼šæä¾›ç¾è§‚çš„å›¾è¡¨ï¼Œå®æ—¶å±•ç¤º RPSã€å“åº”æ—¶é—´ç­‰ã€‚
    *   **ä»£ç å³æµ‹è¯•**ï¼šæµ‹è¯•è„šæœ¬å¯ä»¥åƒä»£ç ä¸€æ ·è¿›è¡Œç‰ˆæœ¬æ§åˆ¶ã€‚

### ğŸ¥ˆ å¤‡é€‰ï¼šApache JMeter

**JMeter** æ˜¯è€ç‰Œçš„ Java å¼€æºå‹åŠ›æµ‹è¯•å·¥å…·ã€‚

*   **ä¼˜ç‚¹**ï¼šåŠŸèƒ½æå…¶ä¸°å¯Œï¼Œæ”¯æŒå„ç§åè®®ï¼ˆHTTP, JDBC, FTP ç­‰ï¼‰ï¼Œæ’ä»¶ç”Ÿæ€å®Œå–„ï¼Œé€‚åˆå¤æ‚çš„é HTTP åè®®æµ‹è¯•ã€‚
*   **ç¼ºç‚¹**ï¼šå­¦ä¹ æ›²çº¿è¾ƒé™¡ï¼ŒGUI é…ç½®è¾ƒç¹çï¼Œèµ„æºæ¶ˆè€—ç›¸å¯¹ Locust è¾ƒé«˜ã€‚

### ğŸ¥‰ å¿«é€ŸåŸºå‡†æµ‹è¯•ï¼šwrk / ab (Apache Bench)

*   **ç”¨é€”**ï¼šç”¨äºå¯¹å•ä¸ªæ¥å£è¿›è¡Œæå…¶å¿«é€Ÿçš„æ€§èƒ½æ‘¸åº•ã€‚
*   **ä¼˜ç‚¹**ï¼šå‘½ä»¤è¡Œæ“ä½œï¼Œç®€å•ç²—æš´ï¼Œæ€§èƒ½æé«˜ã€‚
*   **ç¼ºç‚¹**ï¼šéš¾ä»¥æ¨¡æ‹Ÿå¤æ‚çš„ä¸šåŠ¡åœºæ™¯ï¼ˆå¦‚ï¼šç™»å½• -> è·å– Token -> æŸ¥è¯¢æ•°æ®ï¼‰ã€‚

---

## 3. Locust å¿«é€Ÿä¸Šæ‰‹æŒ‡å—

### 3.1 å®‰è£…

```bash
pip install locust
```

### 3.2 ç¼–å†™æµ‹è¯•è„šæœ¬ (`locustfile.py`)

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º `locustfile.py` çš„æ–‡ä»¶ï¼š

```python
from locust import HttpUser, task, between

class FinancialUser(HttpUser):
    # æ¨¡æ‹Ÿç”¨æˆ·åœ¨ä»»åŠ¡ä¹‹é—´ç­‰å¾… 1 åˆ° 5 ç§’
    wait_time = between(1, 5)

    # è¿™ä¸€æ­¥åœ¨æ¨¡æ‹Ÿç”¨æˆ·å¯åŠ¨æ—¶æ‰§è¡Œï¼Œç”¨äºè·å– Token
    def on_start(self):
        # å‡è®¾æœ‰ä¸€ä¸ªç™»å½•æ¥å£
        # response = self.client.post("/api/v1/auth/login", json={"username": "test", "password": "123"})
        # self.headers = {"Authorization": f"Bearer {response.json()['token']}"}
        pass

    @task(weight=3)
    def view_health_check(self):
        """æƒé‡ä¸º3ï¼Œè¡¨ç¤ºè¢«æ‰§è¡Œçš„æ¦‚ç‡è¾ƒé«˜"""
        self.client.get("/api/v1/health")

    @task(weight=1)
    def view_stock_flow(self):
        """æŸ¥è¯¢èµ„é‡‘æµæ•°æ®"""
        # å¦‚æœéœ€è¦é‰´æƒï¼Œå¯ä»¥åŠ ä¸Š headers=self.headers
        self.client.get("/api/v1/flow?code=000001")

    @task(weight=1)
    def generate_report_simulation(self):
        """æ¨¡æ‹Ÿç”ŸæˆæŠ¥å‘Šï¼ˆæ…ç”¨ï¼Œæ¶ˆè€—è¾ƒå¤§ï¼‰"""
        payload = {
            "table_name": "stock_flow",
            "chat_history": [{"question": "test", "answer": "test"}]
        }
        # ä½¿ç”¨ name å‚æ•°å½’ç±»ç»Ÿè®¡ï¼Œé¿å… URL å‚æ•°å¯¼è‡´æ¡ç›®è¿‡å¤š
        self.client.post("/api/v1/report/generate", json=payload, name="/api/v1/report/generate")
```

### 3.3 è¿è¡Œæµ‹è¯•

åœ¨ç»ˆç«¯è¿è¡Œï¼š

```bash
# å¯åŠ¨ Web UI (é»˜è®¤ç«¯å£ 8089)
locust -f locustfile.py --host=http://localhost:8000
```

### 3.4 å¼€å§‹å‹æµ‹

1.  æ‰“å¼€æµè§ˆå™¨è®¿é—® `http://localhost:8089`ã€‚
2.  è®¾ç½® **Number of users** (ç”¨æˆ·æ€»æ•°ï¼Œä¾‹å¦‚ 100)ã€‚
3.  è®¾ç½® **Spawn rate** (æ¯ç§’å¯åŠ¨ç”¨æˆ·æ•°ï¼Œä¾‹å¦‚ 10)ã€‚
4.  ç‚¹å‡» **Start Swarming** å¼€å§‹æµ‹è¯•ã€‚

---

## 3.5 Apache Bench (ab) å¿«é€Ÿæµ‹è¯•æ¡ˆä¾‹

`ab` æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œéå¸¸é€‚åˆè¿›è¡Œå•æ¥å£çš„æé™å‹åŠ›æµ‹è¯•ã€‚

### 3.5.1 å®‰è£…

- **Ubuntu/Debian**: `sudo apt-get install apache2-utils`
- **CentOS/RHEL**: `sudo yum install httpd-tools`
- **macOS**: é¢„è£…æˆ– `brew install httpd`

### 3.5.2 å¸¸ç”¨å‚æ•°è¯´æ˜

- `-n`: æ€»è¯·æ±‚æ•° (Requests)
- `-c`: å¹¶å‘æ•° (Concurrency)
- `-k`: å¼€å¯ Keep-Alive (å¤ç”¨è¿æ¥ï¼Œå‡å°‘ TCP æ¡æ‰‹å¼€é”€)
- `-p`: POST è¯·æ±‚çš„æ•°æ®æ–‡ä»¶
- `-T`: POST è¯·æ±‚çš„ Content-Type

### 3.5.3 æµ‹è¯•æ¡ˆä¾‹

#### æ¡ˆä¾‹ 1: æµ‹è¯•å¥åº·æ£€æŸ¥æ¥å£ (æœ€ç®€å•çš„ GET è¯·æ±‚)

æµ‹è¯• 1000 ä¸ªè¯·æ±‚ï¼Œå¹¶å‘ 100ï¼š

```bash
ab -n 1000 -c 100 -k http://localhost:8000/api/v1/health
```

#### æ¡ˆä¾‹ 2: æµ‹è¯•éœ€è¦é‰´æƒçš„æŸ¥è¯¢æ¥å£ (å¸¦ Header)

å¦‚æœæ¥å£éœ€è¦ Tokenï¼Œä½¿ç”¨ `-H` å‚æ•°æ·»åŠ  Authorization å¤´ï¼š

```bash
ab -n 500 -c 50 \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  http://localhost:8000/api/v1/flow?code=000001
```

#### æ¡ˆä¾‹ 3: æµ‹è¯•ç”ŸæˆæŠ¥å‘Šæ¥å£ (POST è¯·æ±‚)

1. **å‡†å¤‡æ•°æ®æ–‡ä»¶**ï¼šåˆ›å»ºä¸€ä¸ªåä¸º `post_data.json` çš„æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š
   ```json
   {
       "table_name": "stock_flow",
       "chat_history": []
   }
   ```

2. **æ‰§è¡Œæµ‹è¯•**ï¼š
   ```bash
   ab -n 200 -c 20 \
     -p post_data.json \
     -T "application/json" \
     -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
     http://localhost:8000/api/v1/report/generate
   ```

---

## 4. å…³é”®å…³æ³¨æŒ‡æ ‡

åœ¨æµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œè¯·é‡ç‚¹å…³æ³¨ Locust é¢æ¿ä¸Šçš„ä»¥ä¸‹æŒ‡æ ‡ï¼š

1.  **Requests/s (RPS/QPS)**: æ¯ç§’å¤„ç†çš„è¯·æ±‚æ•°ã€‚è¿™æ˜¯ç³»ç»Ÿååé‡çš„æ ¸å¿ƒæŒ‡æ ‡ã€‚
    *   *ç°è±¡*ï¼šéšç€ç”¨æˆ·æ•°å¢åŠ ï¼ŒRPS åº”è¯¥çº¿æ€§å¢é•¿ï¼Œç›´åˆ°è¾¾åˆ°ç“¶é¢ˆåè¶‹äºå¹³ç¼“æˆ–ä¸‹é™ã€‚
2.  **Median Response Time (ä¸­ä½æ•°å“åº”æ—¶é—´)**: 50% è¯·æ±‚çš„å“åº”æ—¶é—´ã€‚
    *   *æ ‡å‡†*ï¼šé€šå¸¸ API å“åº”æ—¶é—´åº”åœ¨ 200ms - 500ms ä»¥å†…ã€‚
3.  **95th Percentile Response Time (P95)**: 95% çš„è¯·æ±‚å“åº”æ—¶é—´å°äºè¯¥å€¼ã€‚è¿™æ˜¯è¡¡é‡é•¿å°¾å»¶è¿Ÿçš„é‡è¦æŒ‡æ ‡ã€‚
4.  **Failures/s (å¤±è´¥ç‡)**: å¿…é¡»ä¿æŒä¸º 0ã€‚å¦‚æœå‡ºç°éé›¶å€¼ï¼Œè¯´æ˜ç³»ç»Ÿå·²è¿‡è½½æˆ–å‡ºç°é”™è¯¯ï¼ˆå¦‚ 500, 502, 504ï¼‰ã€‚

## 5. å¸¸è§ç“¶é¢ˆä¸ä¼˜åŒ–

*   **æ•°æ®åº“è¿æ¥æ± è€—å°½**ï¼šè°ƒæ•´ SQLAlchemy æˆ–æ•°æ®åº“æœ¬èº«çš„ `max_connections`ã€‚
*   **åŒæ­¥é˜»å¡**ï¼šPython åç«¯å¦‚æœåœ¨ `async` å‡½æ•°ä¸­æ‰§è¡Œäº†è€—æ—¶çš„åŒæ­¥ IO æ“ä½œï¼Œä¼šé˜»å¡ Event Loopï¼Œå¯¼è‡´ååé‡æ€¥å‰§ä¸‹é™ã€‚
    *   *å¯¹ç­–*ï¼šå°†åŒæ­¥æ“ä½œæ”¾å…¥çº¿ç¨‹æ±  (`run_in_threadpool`) æˆ–æ”¹ä¸ºå¼‚æ­¥åº“ (`aiohttp`, `motor`)ã€‚
*   **å¸¦å®½é™åˆ¶**ï¼šä¼ è¾“å¤§é‡æ•°æ®ï¼ˆå¦‚å¤§å›¾ç‰‡ã€é•¿åˆ—è¡¨ï¼‰æ—¶å¯èƒ½è¾¾åˆ°ç½‘ç»œå¸¦å®½ä¸Šé™ã€‚
